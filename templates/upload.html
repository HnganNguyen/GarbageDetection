{% extends "base.html" %}
{% block title %}Ph√¢n Lo·∫°i R√°c{% endblock %}

{% block content %}
<!-- ================== KHUNG CH√çNH ================== -->
<div class="container mt-5">

    <!-- ===== TI√äU ƒê·ªÄ TRANG ===== -->
    <h1 class="text-center text-success fw-bold mb-4">
        ‚ôªÔ∏è PH√ÇN LO·∫†I R√ÅC TH·∫¢I
    </h1>

    <!-- ===== M√î T·∫¢ / H∆Ø·ªöNG D·∫™N ===== -->
    <p class="text-center text-muted">
        Ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ª•p ·∫£nh r√°c tr·ª±c ti·∫øp b·∫±ng camera
        ho·∫∑c t·∫£i ·∫£nh t·ª´ thi·∫øt b·ªã ƒë·ªÉ h·ªá th·ªëng ti·∫øn h√†nh ph√¢n lo·∫°i.
    </p>

    <!-- ================== PH·∫¶N CH·ª§P ·∫¢NH TR·ª∞C TI·∫æP ================== -->
    <div class="text-center mb-5">

        <!-- Ti√™u ƒë·ªÅ khu v·ª±c camera -->
        <h4 class="mb-3">üì∑ Ch·ª•p ·∫£nh tr·ª±c ti·∫øp</h4>

        <!-- Camera hi·ªÉn th·ªã video t·ª´ webcam -->
        <div class="d-flex justify-content-center">
            <video
                id="camera"
                autoplay
                playsinline
                style="
                    width: 100%;
                    max-width: 420px;
                    border-radius: 16px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                ">
            </video>
        </div>

        <!-- N√∫t ch·ª•p ·∫£nh -->
        <button
            id="capture"
            type="button"
            class="btn btn-danger mt-4 px-4 fw-bold">
            üì∏ Ch·ª•p ·∫£nh
        </button>

        <!-- Canvas d√πng ƒë·ªÉ v·∫Ω ·∫£nh ch·ª•p (·∫©n) -->
        <canvas id="canvas" style="display: none;"></canvas>
    </div>

    <hr class="my-4">

    <!-- ================== PH·∫¶N T·∫¢I ·∫¢NH L√äN ================== -->
    <div class="mt-4">

        <!-- Ti√™u ƒë·ªÅ khu v·ª±c upload -->
        <h4 class="text-center mb-3">üìÇ Ho·∫∑c t·∫£i ·∫£nh t·ª´ thi·∫øt b·ªã</h4>

        <!-- ===== FORM G·ª¨I D·ªÆ LI·ªÜU L√äN SERVER ===== -->
        <form
            method="POST"
            action="/"
            enctype="multipart/form-data"
            class="mt-3">

            <!-- Input ·∫©n: l∆∞u ·∫£nh ch·ª•p t·ª´ camera (Base64) -->
            <input
                type="hidden"
                name="captured_image"
                id="captured_image">

            <!-- Input ch·ªçn file ·∫£nh -->
            <div class="mb-3">
                <label for="fileInput" class="form-label">
                    Ch·ªçn file ·∫£nh:
                </label>
                <input
                    type="file"
                    name="file"
                    id="fileInput"
                    class="form-control">
            </div>

            <!-- N√∫t g·ª≠i ·∫£nh ƒë·ªÉ ph√¢n lo·∫°i -->
            <button
                type="submit"
                class="btn btn-success w-100 fw-bold py-2">
                üöÄ Ph√¢n lo·∫°i
            </button>
        </form>
    </div>
</div>

<!-- ================== SCRIPT X·ª¨ L√ù CAMERA ================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    // L·∫•y c√°c ph·∫ßn t·ª≠ HTML c·∫ßn d√πng
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const captureButton = document.getElementById("capture");
    const capturedImageInput = document.getElementById("captured_image");

    /* ===== B·∫¨T CAMERA =====
       - Y√™u c·∫ßu quy·ªÅn truy c·∫≠p webcam
       - Hi·ªÉn th·ªã video tr·ª±c ti·∫øp l√™n th·∫ª <video>
    */
    navigator.mediaDevices
        .getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(error => {
            console.error("L·ªói m·ªü camera:", error);
            alert("Kh√¥ng th·ªÉ truy c·∫≠p camera!");
        });

    /* ===== CH·ª§P ·∫¢NH =====
       - V·∫Ω khung h√¨nh hi·ªán t·∫°i c·ªßa video l√™n canvas
       - Chuy·ªÉn ·∫£nh sang Base64
       - L∆∞u v√†o input ·∫©n ƒë·ªÉ g·ª≠i l√™n server
    */
    captureButton.addEventListener("click", () => {
        const context = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL("image/png");
        capturedImageInput.value = imageData;

        alert("·∫¢nh ƒë√£ ƒë∆∞·ª£c ch·ª•p th√†nh c√¥ng!");
    });
});
</script>
{% endblock %}
